rule DEADBITS_KPOT_V2 : WINMALWARE INFOSTEALER FILE
{
	meta:
		description = "No description has been set in the source file - DeadBits"
		author = "Adam Swanda"
		id = "19e8d261-c658-5d0d-a95c-43fcaf2942e2"
		date = "2019-08-05"
		modified = "2019-08-05"
		reference = "https://github.com/deadbits/yara-rules"
		source_url = "https://github.com/deadbits/yara-rules//blob/d002f7ecee23e09142a3ac3e79c84f71dda3f001/rules/KPOT_v2.yara#L1-L33"
		license_url = "N/A"
		logic_hash = "dc8cce2ae3a427f771b19b4d0e027b653ff03a7bf816303460398987535c5351"
		score = 75
		quality = 80
		tags = "WINMALWARE, INFOSTEALER, FILE"
		Description = "Attempts to detect KPOT version 2 payloads"
		Author = "Adam M. Swanda"

	strings:
		$str01 = "%s: " ascii fullword
		$str02 = " _%s_" ascii fullword
		$str03 = "0|%S|%s|%s|%s" ascii fullword
		$str04 = "%s | %02d/%04d | %s | %s | %s" ascii fullword
		$str05 = "%s | %s | %s | %s | %s | %s | %s | %d | %s" ascii fullword
		$str06 = "%s: %s | %02d/%04d | %s" ascii fullword
		$str07 = "%s = %s" ascii fullword
		$str08 = "password-check" ascii fullword
		$conf_re1 = /(SMTP|POP3|IMAP)\sServer/ wide
		$conf_re2 = /(SMTP|POP3|IMAP)\s(User|Password|Port)/ wide
		$conf01 = "*.config" ascii wide fullword
		$conf02 = "HTTP Server URL" ascii wide fullword
		$conf03 = "%s: %d" ascii wide fullword
		$conf04 = "%s\\Outlook.txt" ascii wide fullword

	condition:
		uint16( 0 ) == 0x5a4d and all of ( $str* ) and all of ( $conf_re* ) and all of ( $conf0* )
}

rule DEADBITS_APT34_PICKPOCKET : APT APT34 INFOSTEALER WINMALWARE FILE
{
	meta:
		description = "Detects the PICKPOCKET malware used by APT34, a browser credential-theft tool identified by FireEye in May 2018"
		author = "Adam Swanda"
		id = "71db5c74-4964-5c5e-a830-242bfd0a2158"
		date = "2019-07-22"
		modified = "2019-07-22"
		reference = "https://www.fireeye.com/blog/threat-research/2019/07/hard-pass-declining-apt34-invite-to-join-their-professional-network.html"
		source_url = "https://github.com/deadbits/yara-rules//blob/d002f7ecee23e09142a3ac3e79c84f71dda3f001/rules/APT34_PICKPOCKET.yara#L1-L30"
		license_url = "N/A"
		logic_hash = "7063cff3eb42c4468e01c9b214161cd306f7126f66650d99d43168730d1dc83a"
		score = 75
		quality = 80
		tags = "APT, APT34, INFOSTEALER, WINMALWARE, FILE"

	strings:
		$s1 = "SELECT * FROM moz_logins;" ascii fullword
		$s2 = "\\nss3.dll" ascii fullword
		$s3 = "SELECT * FROM logins;" ascii fullword
		$s4 = "| %Q || substr(name,%d+18) ELSE name END WHERE tbl_name=%Q COLLATE nocase AND (type='table' OR type='index' OR type='trigger');" ascii fullword
		$s5 = "\\Login Data" ascii fullword
		$s6 = "%s\\Mozilla\\Firefox\\profiles.ini" ascii fullword
		$s7 = "Login Data" ascii fullword
		$s8 = "encryptedUsernamencryptedPasswor" ascii fullword
		$s10 = "%s\\Mozilla\\Firefox\\%s" ascii fullword
		$s11 = "encryptedUsername" ascii fullword
		$s12 = "2013-12-06 14:53:30 27392118af4c38c5203a04b8013e1afdb1cebd0d" ascii fullword
		$s13 = "27392118af4c38c5203a04b8013e1afdb1cebd0d" ascii
		$s15 = "= 'table' AND name!='sqlite_sequence'   AND coalesce(rootpage,1)>0" ascii fullword
		$s18 = "[*] FireFox :" fullword wide
		$s19 = "[*] Chrome :" fullword wide
		$s20 = "username_value" ascii fullword

	condition:
		uint16( 0 ) == 0x5a4d and ( 8 of them or all of them )
}

rule DEADBITS_Avemaria_Warzone : AVEMARIA WARZONE WINMALWARE INFOSTEALER FILE
{
	meta:
		description = "No description has been set in the source file - DeadBits"
		author = "Adam Swanda"
		id = "1e03927b-d59c-5e1f-bdee-e44dfb172fad"
		date = "2019-07-18"
		modified = "2019-08-08"
		reference = "https://github.com/deadbits/yara-rules"
		source_url = "https://github.com/deadbits/yara-rules//blob/d002f7ecee23e09142a3ac3e79c84f71dda3f001/rules/avemaria_warzone.yara#L1-L32"
		license_url = "N/A"
		logic_hash = "1fe55fc8ea80616b11757193c2c74b9cf577ab661ddca4c6c64cfad63a300614"
		score = 75
		quality = 80
		tags = "AVEMARIA, WARZONE, WINMALWARE, INFOSTEALER, FILE"
		Author = "Adam M. Swanda"

	strings:
		$str1 = "cmd.exe /C ping 1.2.3.4 -n 2 -w 1000 > Nul & Del /f /q " ascii fullword
		$str2 = "MsgBox.exe" wide fullword
		$str4 = "\\System32\\cmd.exe" wide fullword
		$str6 = "Ave_Maria" wide
		$str7 = "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\SpecialAccounts\\UserList" ascii fullword
		$str8 = "SMTP Password" wide fullword
		$str11 = "\\Google\\Chrome\\User Data\\Default\\Login Data" wide fullword
		$str12 = "\\sqlmap.dll" wide fullword
		$str14 = "SELECT * FROM logins" ascii fullword
		$str16 = "Elevation:Administrator!new" wide
		$str17 = "/n:%temp%" ascii wide

	condition:
		( uint16( 0 ) == 0x5a4d and filesize < 400KB ) and ( 5 of ( $str* ) or all of them )
}

rule DEADBITS_APT32_Ratsnif : APT32 TROJAN WINMALWARE FILE
{
	meta:
		description = "No description has been set in the source file - DeadBits"
		author = "Adam Swanda"
		id = "d3664a84-bb53-5715-8b0d-e63f43d62496"
		date = "2019-07-18"
		modified = "2019-08-08"
		reference = "https://github.com/deadbits/yara-rules"
		source_url = "https://github.com/deadbits/yara-rules//blob/d002f7ecee23e09142a3ac3e79c84f71dda3f001/rules/APT32_Ratsnif.yara#L1-L65"
		license_url = "N/A"
		logic_hash = "a33eb2bb9ffe02f9b3fe706bd6a611457c669adc24c34f12d9014ed29ba1399f"
		score = 75
		quality = 55
		tags = "APT32, TROJAN, WINMALWARE, FILE"
		Author = "Adam M. Swanda"

	strings:
		$pdb0 = "X:\\Project\\BotFrame\\Debug\\Client.pdb" ascii fullword
		$str1 = "LastIP" ascii fullword
		$str2 = "LastOnline" ascii fullword
		$str3 = "LoaderType" ascii fullword
		$str4 = "Payload" ascii fullword
		$str5 = "PayloadFile" ascii fullword
		$str6 = "ClientCommand" ascii fullword
		$str7 = "ClientId" ascii fullword
		$str8 = "UserAdmin" ascii fullword
		$str9 = "User" ascii fullword
		$str10 = "Password" ascii fullword
		$str11 = "Access" ascii fullword
		$str12 = "CreateDate" ascii fullword
		$str13 = "CreateBy" ascii fullword
		$str14 = "UserName" ascii fullword
		$str15 = "ComputerName" ascii fullword
		$str16 = "Domain" ascii fullword
		$str17 = "OSType" ascii fullword
		$str18 = "OSArch" ascii fullword
		$str19 = "OSVer" ascii fullword
		$str20 = "InstallDate" ascii fullword
		$str21 = "LastLoadCommandID" ascii fullword
		$str22 = "Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36" ascii fullword
		$str25 = "#########################Program starting up#########################" ascii fullword
		$str26 = "Stop poison" ascii fullword
		$str27 = "Shell:" ascii fullword
		$str28 = "shell" ascii fullword
		$str29 = "Select http redirect domain:" ascii fullword
		$str30 = "HTTP redirect add file extension:" ascii fullword
		$str32 = "exIp" ascii fullword
		$str33 = "Start Poison" ascii fullword
		$str34 = "vicIP" ascii fullword
		$str35 = "Insert JSTag" ascii fullword
		$str36 = "devIp" ascii fullword
		$str37 = "TransmitTcp" ascii fullword
		$str38 = "Remove poison IP: %s" ascii fullword
		$str39 = "Remove my ip or gateway ip: %s" ascii fullword
		$cnc0 = "/cl_client_online.php" ascii fullword
		$cnc1 = "/cl_client_cmd.php" ascii fullword
		$cnc2 = "/cl_client_cmd_res.php" ascii fullword
		$cnc3 = "/cl_client_file_download.php" ascii fullword
		$cnc4 = "/ad_file_download.php" ascii fullword
		$cnc5 = "/cl_client_file_upload.php" ascii fullword
		$cnc6 = "/cl_client_logs.php" ascii fullword

	condition:
		( uint16( 0 ) == 0x5a4d ) and ( ( 10 of ( $str* ) and 3 of ( $cnc* ) ) or ( 3 of ( $cnc* ) and $pdb0 ) )
}

rule DEADBITS_APT34_VALUEVAULT : APT34 INFOSTEALER WINMALWARE FILE
{
	meta:
		description = "No description has been set in the source file - DeadBits"
		author = "Adam Swanda"
		id = "11d08fe7-9080-5393-b566-6f01e3eec18b"
		date = "2020-02-02"
		modified = "2020-02-02"
		reference = "https://www.fireeye.com/blog/threat-research/2019/07/hard-pass-declining-apt34-invite-to-join-their-professional-network.html"
		source_url = "https://github.com/deadbits/yara-rules//blob/d002f7ecee23e09142a3ac3e79c84f71dda3f001/rules/APT34_VALUEVAULT.yara#L1-L63"
		license_url = "N/A"
		logic_hash = "311eed153920b29b8d9e99651fe62259d685140d12bb073001e0576811a01198"
		score = 75
		quality = 78
		tags = "APT34, INFOSTEALER, WINMALWARE, FILE"
		Description = "Information stealing malware used by APT34, written in Go."

	strings:
		$fsociety = "fsociety.dat" ascii
		$powershell = "New-Object -ComObject Shell.Application" ascii
		$gobuild = "Go build ID: " ascii
		$gopath01 = "browsers-password-cracker" ascii nocase
		$gopath02 = "main.go" ascii nocase
		$gopath03 = "mozilla.go" ascii nocase
		$gopath04 = "ie.go" ascii nocase
		$str1 = "main.Decrypt" ascii fullword
		$str3 = "main.NewBlob" ascii fullword
		$str4 = "main.CheckFileExist" ascii fullword
		$str5 = "main.CopyFileToDirectory" ascii fullword
		$str6 = "main.CrackChromeBased" ascii fullword
		$str7 = "main.CrackIE" ascii fullword
		$str8 = "main.decipherPassword" ascii fullword
		$str9 = "main.DecodeUTF16" ascii fullword
		$str10 = "main.getHashTable" ascii fullword
		$str11 = "main.getHistory" ascii fullword
		$str12 = "main.getHistoryWithPowerShell" ascii fullword
		$str13 = "main.getHistoryFromRegistery" ascii fullword
		$str14 = "main.main" ascii fullword
		$str15 = "main.DecryptAESFromBase64" ascii fullword
		$str16 = "main.DecryptAES" ascii fullword
		$str17 = "main.CrackMozila" ascii fullword
		$str18 = "main.decodeLoginData" ascii fullword
		$str19 = "main.decrypt" ascii fullword
		$str20 = "main.removePadding" ascii fullword
		$str21 = "main.getLoginData" ascii fullword
		$str22 = "main.isMasterPasswordCorrect" ascii fullword
		$str23 = "main.decrypt3DES" ascii fullword
		$str24 = "main.getKey" ascii fullword
		$str25 = "main.manageMasterPassword" ascii fullword
		$str26 = "main.getFirefoxProfiles" ascii fullword
		$str27 = "main._Cfunc_DumpVault" ascii fullword
		$str28 = "main.CrackIEandEdgeNew" ascii fullword
		$str29 = "main.init.ializers" ascii fullword
		$str30 = "main.init" ascii fullword

	condition:
		uint16( 0 ) == 0x5a4d and ( ( 10 of ( $str* ) and 3 of ( $gopath* ) ) or ( $fsociety and $powershell and $gobuild ) or ( $fsociety and 10 of ( $str* ) ) )
}

rule DEADBITS_APT34_LONGWATCH : APT34 WINMALWARE KEYLOGGER FILE
{
	meta:
		description = "No description has been set in the source file - DeadBits"
		author = "Adam Swanda"
		id = "74a6a408-2f0e-567d-8968-c304d258df81"
		date = "2019-07-22"
		modified = "2019-07-22"
		reference = "https://www.fireeye.com/blog/threat-research/2019/07/hard-pass-declining-apt34-invite-to-join-their-professional-network.html"
		source_url = "https://github.com/deadbits/yara-rules//blob/d002f7ecee23e09142a3ac3e79c84f71dda3f001/rules/APT34_LONGWATCH.yara#L1-L43"
		license_url = "N/A"
		logic_hash = "8f9ed228325800baea3a2874c71337709c04d93419d4d56821a791dbce6f4582"
		score = 75
		quality = 78
		tags = "APT34, WINMALWARE, KEYLOGGER, FILE"
		Description = "APT34 Keylogger"

	strings:
		$log = "c:\\windows\\temp\\log.txt" ascii fullword
		$clipboard = "---------------CLIPBOARD------------" ascii fullword
		$func0 = "\"Main Invoked.\"" ascii fullword
		$func1 = "\"Main Returned.\"" ascii fullword
		$logger3 = ">---------------------------------------------------" ascii fullword
		$logger4 = "[ENTER]" ascii fullword
		$logger5 = "[CapsLock]" ascii fullword
		$logger6 = "[CRTL]" ascii fullword
		$logger7 = "[PAGE_UP]" ascii fullword
		$logger8 = "[PAGE_DOWN]" ascii fullword
		$logger9 = "[HOME]" ascii fullword
		$logger10 = "[LEFT]" ascii fullword
		$logger11 = "[RIGHT]" ascii fullword
		$logger12 = "[DOWN]" ascii fullword
		$logger13 = "[PRINT]" ascii fullword
		$logger14 = "[PRINT SCREEN]" ascii fullword
		$logger15 = "[INSERT]" ascii fullword
		$logger16 = "[SLEEP]" ascii fullword
		$logger17 = "[PAUSE]" ascii fullword
		$logger18 = "[TAB]" ascii fullword
		$logger19 = "[ESC]" ascii fullword
		$logger20 = "[DEL]" ascii fullword
		$logger21 = "[ALT]" ascii fullword

	condition:
		uint16( 0 ) == 0x5a4d and $log and all of ( $func* ) and all of ( $logger* ) and $clipboard
}

rule DEADBITS_TA505_Flowerpippi : TA505 FINANCIAL BACKDOOR WINMALWARE FILE
{
	meta:
		description = "No description has been set in the source file - DeadBits"
		author = "Adam Swanda"
		id = "1cfcb25e-1de9-53ac-b272-22792844a2d0"
		date = "2019-07-18"
		modified = "2019-07-22"
		reference = "https://github.com/deadbits/yara-rules"
		source_url = "https://github.com/deadbits/yara-rules//blob/d002f7ecee23e09142a3ac3e79c84f71dda3f001/rules/TA505_FlowerPippi.yara#L1-L65"
		license_url = "N/A"
		logic_hash = "eb709915f67d7225b024da99bc84a21455f3b9d5fb4bc779bbdf6a4d3ab33489"
		score = 75
		quality = 24
		tags = "TA505, FINANCIAL, BACKDOOR, WINMALWARE, FILE"
		Author = "Adam M. Swanda"

	strings:
		$pipi = "pipipipip" ascii fullword
		$pdb0 = "Loader.pdb" ascii fullword
		$str0 = "bot.php" ascii fullword
		$str1 = "%.2X" ascii fullword
		$str2 = "sd.bat" ascii fullword
		$str3 = "open" ascii fullword
		$str4 = "domain" ascii fullword
		$str5 = "proxy" ascii fullword
		$str6 = ".exe" ascii fullword
		$str7 = "Can't launch EXE file" ascii fullword
		$str8 = "Can't load file" ascii fullword
		$str9 = ".dll" ascii fullword
		$str10 = "Dll function not found" ascii fullword
		$str11 = "Can't load Dll" ascii fullword
		$str12 = "__start_session__" ascii fullword
		$str13 = "__failed__" ascii fullword
		$str14 = "RSDSG" ascii fullword
		$str15 = "ProxyServer" ascii fullword
		$str16 = ":Repeat" ascii fullword
		$str17 = "del \"%s\"" ascii fullword
		$str18 = "if exist \"%s\" goto Repeat" ascii fullword
		$str19 = "rmdir \"%s" ascii fullword
		$str20 = "del \"%s\"" ascii fullword
		$str21 = "Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings" ascii fullword
		$str22 = "ProxyEnable" ascii fullword
		$str23 = ".00cfg" ascii fullword
		$str24 = ".idata" ascii fullword
		$api0 = "IsProcessorFeaturePresent" ascii fullword
		$api1 = "IsDebuggerPresent" ascii fullword
		$api2 = "HttpOpenRequestA" ascii fullword
		$api3 = "InternetCrackUrlA" ascii fullword
		$api4 = "InternetOpenW" ascii fullword
		$api5 = "HttpSendRequestW" ascii fullword
		$api6 = "InternetCloseHandle" ascii fullword
		$api7 = "InternetConnectA" ascii fullword
		$api8 = "InternetSetOptionW" ascii fullword
		$api9 = "InternetReadFile" ascii fullword
		$api10 = "WININET.dll" ascii fullword
		$api11 = "URLDownloadToFileA" ascii fullword

	condition:
		uint16( 0 ) == 0x5a4d and filesize < 700KB and ( ( 10 of ( $str* ) and $pipi ) or ( 10 of ( $str* ) and $pdb0 ) or ( 10 of ( $str* ) and 5 of ( $api* ) ) or ( all of them ) )
}

